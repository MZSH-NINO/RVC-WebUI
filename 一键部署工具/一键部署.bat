@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

REM ========================================
REM RVC-WebUI äº¤äº’å¼ä¸€é”®éƒ¨ç½²è„šæœ¬
REM ========================================

REM åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
cd /d "%~dp0\.."

:main_menu

REM ========================================
REM ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ˜¾å¡ç±»å‹
REM ========================================

:select_gpu
cls
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘                                                              â•‘
echo â•‘           RVC-WebUI äº¤äº’å¼ä¸€é”®éƒ¨ç½²è„šæœ¬ v1.0                  â•‘
echo â•‘                                                              â•‘
echo â•‘           è®©å°ç™½ç”¨æˆ·ä¹Ÿèƒ½è½»æ¾éƒ¨ç½² AI å˜å£°ç³»ç»Ÿï¼              â•‘
echo â•‘                                                              â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
echo â”‚ æ­¥éª¤ 1/2: é€‰æ‹©æ‚¨çš„æ˜¾å¡ç±»å‹                                   â”‚
echo â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
echo.
echo   [1] NVIDIA æ˜¾å¡ (æ¨è)
echo       - ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¼ºï¼ŒCUDA åŠ é€Ÿ
echo       - éœ€è¦ï¼šNVIDIA æ˜¾å¡é©±åŠ¨
echo.
echo   [2] AMD / Intel æ˜¾å¡
echo       - ä¼˜ç‚¹ï¼šæ”¯æŒ DirectML åŠ é€Ÿ
echo       - è¯´æ˜ï¼šæ€§èƒ½ä¸å¦‚ NVIDIA
echo.
echo   [3] ä»…ä½¿ç”¨ CPU
echo       - è¯´æ˜ï¼šè¿è¡Œè¾ƒæ…¢ï¼Œä¸æ¨è
echo.
echo   [0] é€€å‡ºå®‰è£…
echo.
set /p GPU_CHOICE="è¯·è¾“å…¥é€‰é¡¹ [1/2/3/0]: "

if "%GPU_CHOICE%"=="0" exit /b 0
if "%GPU_CHOICE%"=="1" (
    set "DEVICE_TYPE=nvidia"
    set "REQ_FILE=requirements.txt"
    goto check_conda
)
if "%GPU_CHOICE%"=="2" (
    set "DEVICE_TYPE=dml"
    set "REQ_FILE=requirements-dml.txt"
    goto check_conda
)
if "%GPU_CHOICE%"=="3" (
    set "DEVICE_TYPE=cpu"
    set "REQ_FILE=requirements.txt"
    goto check_conda
)
echo.
echo [é”™è¯¯] æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©
timeout /t 2 >nul
goto select_gpu

REM ========================================
REM æ£€æµ‹ Conda ç¯å¢ƒ
REM ========================================

:check_conda
cls
echo.
echo [ä¿¡æ¯] æ­£åœ¨æ£€æµ‹ Conda ç¯å¢ƒ...
echo.

where conda >nul 2>&1
if %errorlevel% neq 0 (
    echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    echo â•‘                                                              â•‘
    echo â•‘                      âŒ ç¯å¢ƒæ£€æµ‹å¤±è´¥                         â•‘
    echo â•‘                                                              â•‘
    echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    echo.
    echo [é”™è¯¯] æœªæ£€æµ‹åˆ° Conda ç¯å¢ƒ
    echo.
    echo [è§£å†³æ–¹æ¡ˆ] è¯·å…ˆå®‰è£… Miniconda æˆ– Anacondaï¼š
    echo   ä¸‹è½½åœ°å€ï¼šhttps://docs.conda.io/en/latest/miniconda.html
    echo.
    echo   å®‰è£…å®Œæˆåï¼Œè¯·é‡æ–°è¿è¡Œæœ¬è„šæœ¬ã€‚
    echo.
    pause
    goto select_gpu
)

echo [âœ“] æ£€æµ‹åˆ° Conda ç¯å¢ƒ
goto confirm_install

REM ========================================
REM ç¡®è®¤å®‰è£…é…ç½®
REM ========================================

:confirm_install
cls
echo.
echo â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
echo â”‚ æ­¥éª¤ 2/2: ç¡®è®¤å®‰è£…é…ç½®                                       â”‚
echo â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
echo.
echo   ç³»ç»Ÿå·²è‡ªåŠ¨æ£€æµ‹æ‚¨çš„é…ç½®ï¼š
echo   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo   ç¯å¢ƒç±»å‹ï¼šConda
if "!DEVICE_TYPE!"=="nvidia" (
    echo   è®¾å¤‡ç±»å‹ï¼šNVIDIA æ˜¾å¡
    echo   PyTorchï¼š  CUDA ç‰ˆæœ¬
    echo   æ€§èƒ½ï¼š    âš¡ GPU åŠ é€Ÿ ^(å¿«é€Ÿ^)
)
if "!DEVICE_TYPE!"=="dml" (
    echo   è®¾å¤‡ç±»å‹ï¼šAMD/Intel æ˜¾å¡
    echo   PyTorchï¼š  DirectML åŠ é€Ÿ
    echo   æ€§èƒ½ï¼š    ğŸ”¥ GPU åŠ é€Ÿ ^(ä¸­ç­‰^)
)
if "!DEVICE_TYPE!"=="cpu" (
    echo   è®¾å¤‡ç±»å‹ï¼šä»… CPU
    echo   PyTorchï¼š  CPU ç‰ˆæœ¬
    echo   æ€§èƒ½ï¼š    ğŸŒ CPU æ¨¡å¼ ^(è¾ƒæ…¢^)
)
echo   ç¯å¢ƒåç§°ï¼šRVC-WebUI
echo   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.
echo   é¢„è®¡å®‰è£…æ—¶é—´ï¼š10-30 åˆ†é’Ÿ ^(å–å†³äºç½‘é€Ÿ^)
echo.
echo   [1] ç¡®è®¤å¹¶å¼€å§‹å®‰è£…
echo   [0] è¿”å›ä¸Šä¸€æ­¥
echo.
set /p CONFIRM="è¯·ç¡®è®¤ [1/0]: "

if "%CONFIRM%"=="0" goto select_gpu
if "%CONFIRM%"=="1" goto start_install
echo [é”™è¯¯] æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©
timeout /t 2 >nul
goto confirm_install

REM ========================================
REM å¼€å§‹å®‰è£…
REM ========================================

:start_install
cls
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘                    å¼€å§‹å®‰è£… RVC-WebUI                        â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo [ä¿¡æ¯] å®‰è£…æ–¹å¼ï¼šConda + !DEVICE_TYPE!
echo [ä¿¡æ¯] å®‰è£…è¿‡ç¨‹å¯èƒ½éœ€è¦ 10-30 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...
echo.

echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo   Conda å®‰è£…æµç¨‹
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.

echo [1/7] æ£€æŸ¥ Conda ç¯å¢ƒ...
conda info --envs | findstr "RVC-WebUI" >nul
if %errorlevel% equ 0 (
    echo [âœ“] æ£€æµ‹åˆ°å·²å­˜åœ¨ RVC-WebUI ç¯å¢ƒï¼Œè·³è¿‡åˆ›å»º
    goto conda_activate
)

echo [2/7] åˆ›å»º Python 3.10 è™šæ‹Ÿç¯å¢ƒ...
conda create -n RVC-WebUI python=3.10 -y
if %errorlevel% neq 0 (
    echo [âœ—] ç¯å¢ƒåˆ›å»ºå¤±è´¥
    pause
    exit /b 1
)

:conda_activate
echo [3/7] æ¿€æ´»ç¯å¢ƒ...
call conda activate RVC-WebUI
if %errorlevel% neq 0 (
    echo [âœ—] ç¯å¢ƒæ¿€æ´»å¤±è´¥
    pause
    exit /b 1
)

echo [4/7] å®‰è£… PyTorch...
if "!DEVICE_TYPE!"=="nvidia" (
    echo [ä¿¡æ¯] å®‰è£… CUDA ç‰ˆæœ¬ PyTorch
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu117
) else (
    echo [ä¿¡æ¯] å®‰è£… CPU ç‰ˆæœ¬ PyTorch
    pip install torch torchvision torchaudio
)
if %errorlevel% neq 0 (
    echo [âœ—] PyTorch å®‰è£…å¤±è´¥
    pause
    exit /b 1
)

echo [5/7] é™çº§ pip ç‰ˆæœ¬ä»¥å…¼å®¹æ—§ç‰ˆä¾èµ–...
python -m pip install "pip<24.1"
if %errorlevel% neq 0 (
    echo [âš ï¸] pip é™çº§å¤±è´¥ï¼Œç»§ç»­å®‰è£…...
)

echo [6/7] å®‰è£…é¡¹ç›®ä¾èµ–...
pip install -r !REQ_FILE!
if %errorlevel% neq 0 (
    echo [âœ—] ä¾èµ–å®‰è£…å¤±è´¥
    pause
    exit /b 1
)

echo [7/7] ä¸‹è½½å¿…éœ€æ–‡ä»¶...
call :download_models
if %errorlevel% neq 0 (
    echo [âš ï¸] éƒ¨åˆ†æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œä½†ä¸å½±å“åŸºæœ¬ä½¿ç”¨
)

goto install_complete

REM ========================================
REM ä¸‹è½½æ¨¡å‹å’Œå·¥å…·
REM ========================================

:download_models
echo.
echo [ä¿¡æ¯] ä¸‹è½½ ffmpeg å’Œ ffprobe...
python "%~dp0download_ffmpeg.py"
if %errorlevel% neq 0 (
    echo [âš ï¸] ffmpeg ä¸‹è½½å¤±è´¥
)

echo.
echo [ä¿¡æ¯] ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹ ^(çº¦ 2GBï¼Œéœ€è¦è¾ƒé•¿æ—¶é—´^)...
echo [æç¤º] å¦‚ä¸‹è½½å¤±è´¥ï¼Œå¯ç¨åæ‰‹åŠ¨è¿è¡Œ tools\download_models.py
python tools\download_models.py
if %errorlevel% neq 0 (
    echo [âš ï¸] æ¨¡å‹ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åæ‰‹åŠ¨ä¸‹è½½
)
exit /b 0

REM ========================================
REM å®‰è£…å®Œæˆ
REM ========================================

:install_complete
cls
echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘                                                              â•‘
echo â•‘                   ğŸ‰ å®‰è£…å®Œæˆï¼ğŸ‰                           â•‘
echo â•‘                                                              â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo   å®‰è£…ä¿¡æ¯
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.
echo   ç¯å¢ƒç±»å‹ï¼šConda
echo   ç¯å¢ƒåç§°ï¼šRVC-WebUI
if "!DEVICE_TYPE!"=="nvidia" (
    echo   è®¾å¤‡ç±»å‹ï¼šNVIDIA æ˜¾å¡ ^(CUDA åŠ é€Ÿ^)
)
if "!DEVICE_TYPE!"=="dml" (
    echo   è®¾å¤‡ç±»å‹ï¼šAMD/Intel æ˜¾å¡ ^(DirectML åŠ é€Ÿ^)
)
if "!DEVICE_TYPE!"=="cpu" (
    echo   è®¾å¤‡ç±»å‹ï¼šä»… CPU
)
echo.
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo   ä½¿ç”¨æ–¹æ³•
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.
echo   å¿«é€Ÿå¯åŠ¨ï¼š
echo   1. åŒå‡»è¿è¡Œé¡¹ç›®æ ¹ç›®å½•çš„"ä¸€é”®å¯åŠ¨.bat"
echo.
echo   æ‰‹åŠ¨å¯åŠ¨ï¼š
echo   1. æ¿€æ´»ç¯å¢ƒï¼šconda activate RVC-WebUI
echo   2. å¯åŠ¨ WebUIï¼špython infer-web.py
echo   3. åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://127.0.0.1:7865
echo.
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo   æ€§èƒ½å»ºè®®
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.
if "!DEVICE_TYPE!"=="nvidia" (
    echo   [âœ“] CUDA åŠ é€Ÿå·²å¯ç”¨
    echo   [æç¤º] æ¨èä½¿ç”¨ NVIDIA RTX ç³»åˆ—æ˜¾å¡ä»¥è·å¾—æœ€ä½³æ€§èƒ½
)
if "!DEVICE_TYPE!"=="dml" (
    echo   [âœ“] DirectML åŠ é€Ÿå·²å¯ç”¨
    echo   [æç¤º] AMD/Intel æ˜¾å¡æ€§èƒ½å¯èƒ½ä¸å¦‚ NVIDIA
)
if "!DEVICE_TYPE!"=="cpu" (
    echo   [âš ï¸] CPU æ¨¡å¼è¿è¡Œè¾ƒæ…¢
    echo   [æç¤º] å¦‚æœ‰ç‹¬ç«‹æ˜¾å¡ï¼Œå»ºè®®é‡æ–°å®‰è£…å¹¶é€‰æ‹© GPU åŠ é€Ÿ
)
echo.
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo   æŠ€æœ¯æ”¯æŒ
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.
echo   GitHubï¼šhttps://github.com/RVC-Project/Retrieval-based-Voice-Conversion-WebUI
echo   å¸¸è§é—®é¢˜ï¼šæŸ¥çœ‹é¡¹ç›® Wiki æˆ– Issues
echo.
echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo.
pause
exit /b 0
